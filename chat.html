<script>
lucide.createIcons();

const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const webhookGrafico = "https://rubaseval.app.n8n.cloud/webhook-test/grafico";
const supabaseUrl = "https://TU_URL_SUPABASE.supabase.co";
const supabaseKey = "TU_API_KEY";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
let chartInstance = null;

document.getElementById("userInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendText();
});

function appendMessage(sender, text) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerText = text;
  const box = document.getElementById("messages");
  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}

function showTyping() {
  if (document.getElementById("typing")) return;
  const div = document.createElement("div");
  div.id = "typing";
  div.className = "typing";
  div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  document.getElementById("messages").appendChild(div);
}
function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}

async function sendText() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";
  showTyping();

  try {
    const res = await fetch(webhook, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({type:"text", content:text})
    });
    const data = await res.json();
    removeTyping();

    if (data.respuesta && !data.respuesta.includes("|")) appendMessage("bot", data.respuesta);

    // Si devuelve tabla
    if (typeof data.respuesta === "string" && data.respuesta.includes("|")) {
      renderMarkdownTable(data.respuesta);
      renderGraficarButton(data.sql, data.recomendacion, data.consulta); // üü© NUEVO
    }
  } catch (err) {
    console.error(err);
    removeTyping();
    appendMessage("bot", "Error al conectar con el agente.");
  }
}

function renderMarkdownTable(text) {
  const lines = text.trim().split("\n").filter(l => l.includes("|"));
  if (lines.length < 2) return;
  const headers = lines[0].split("|").map(h => h.trim()).filter(Boolean);
  const rows = lines.slice(2).map(line => line.split("|").map(c => c.trim()).filter(Boolean));

  let html = "<table><thead><tr>";
  headers.forEach(h => html += `<th>${h}</th>`);
  html += "</tr></thead><tbody>";
  rows.forEach(r => html += "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>");
  html += "</tbody></table>";
  document.getElementById("tablaContainer").innerHTML = html;
}

// üü© NUEVO: bot√≥n ‚ÄúGraficar‚Äù
function renderGraficarButton(sql, recomendacion, consulta) {
  const div = document.getElementById("chartButtons");
  div.innerHTML = `
    <button class="btn-rec" onclick='obtenerCamposGrafico(${JSON.stringify(sql)}, ${JSON.stringify(recomendacion)}, ${JSON.stringify(consulta)})'>
      Graficar
    </button>
  `;
}

// üü© NUEVO: llama al segundo webhook para obtener x, y, chart_type
async function obtenerCamposGrafico(sql, recomendacion, consulta) {
  try {
    const res = await fetch(webhookGrafico, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ sql, consulta, decision: recomendacion })
    });
    const data = await res.json();
    renderChartButtons(data.sql, data.chart_type, data.x, data.y, consulta);
  } catch (err) {
    console.error("Error al obtener datos de gr√°fico:", err);
  }
}

function renderChartButtons(sql, chartType, x, y, consulta) {
  const div = document.getElementById("chartButtons");
  const tipos = ["bar", "line", "scatter", "pie", "histogram"];

  // üü© Poner recomendado al principio
  const cleanType = chartType.replace(/[()]/g,"").trim();
  const tiposOrdenados = [cleanType, ...tipos.filter(t => t !== cleanType)];

  div.innerHTML = `
    <p><strong>Selecciona tipo de gr√°fico:</strong></p>
    <div class="btn-group">
      ${tiposOrdenados.map(t => `
        <button class="btn-chart ${t===cleanType ? "btn-rec" : "btn-alt"}"
          onclick="renderChartFromSQL('${sql}','${t}','${x}','${y}')">
          ${t===cleanType ? `Recomendado (${t})` : t}
        </button>`).join("")}
    </div>
  `;
}

async function renderChartFromSQL(sql, chartType, xField, yField) {
  try {
    const { data, error } = await supabase.rpc("execute_sql_query", { query: sql });
    if (error) throw error;
    if (!data?.length) {
      document.getElementById("tablaContainer").innerHTML = "Sin datos para graficar.";
      return;
    }

    const labels = data.map(row => row[xField]);
    const values = data.map(row => row[yField]);

    const ctx = document.getElementById("chart").getContext("2d");
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: chartType,
      data: {
        labels,
        datasets: [{
          label: `${yField} vs ${xField}`,
          data: values,
          backgroundColor: "rgba(47,110,62,0.6)",
          borderColor: "rgba(47,110,62,1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch (err) {
    console.error(err);
    document.getElementById("tablaContainer").innerHTML = "Error al generar el gr√°fico.";
  }
}
</script>
