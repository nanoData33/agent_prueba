<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cohortlab ‚Äì Asistente Cl√≠nico</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --verde: #2f6e3e;
  --verde-oscuro: #245831;
  --gris: #3b3b3b;
  --fondo: #f4f7f4;
  --card: #ffffff;
}
body {
  font-family: "Poppins", sans-serif;
  background: var(--fondo);
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  color: var(--gris);
}
header {
  background: var(--card);
  padding: 15px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
header h1 {
  color: var(--verde);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1.2rem;
}
header button {
  background: var(--verde);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 500;
}
header button:hover { background: var(--verde-oscuro); }

main {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  padding: 20px;
}
.chat-box, .tabla-box {
  background: var(--card);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
}
h2 {
  text-align: center;
  color: var(--verde);
  margin-bottom: 10px;
}
.messages {
  flex: 1;
  overflow-y: auto;
  background: #f8faf8;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
}
.msg {
  margin-bottom: 12px;
  padding: 12px 15px;
  border-radius: 10px;
  max-width: 85%;
  line-height: 1.5;
}
.msg.user {
  background: var(--verde);
  color: white;
  align-self: flex-end;
}
.msg.bot {
  background: #e8f3e8;
  color: var(--gris);
  align-self: flex-start;
}
.input-area {
  display: flex;
  gap: 8px;
}
input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
}
button.action {
  background: var(--verde);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
}
button.action:hover { background: var(--verde-oscuro); }

#tablaContainer {
  overflow-x: auto;
  margin-bottom: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.9rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
}
th { background: var(--verde); color: white; }

#chartButtons {
  margin-top: 15px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.btn-chart {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: 0.2s;
}
.btn-chart.rec { background: var(--verde); color: white; }
.btn-chart.alt { background: #e6e8e6; color: var(--gris); }
.btn-chart.alt:hover { background: #d5d8d5; }
canvas { width: 100% !important; height: 380px !important; }

footer {
  background: var(--card);
  text-align: center;
  padding: 8px;
  font-size: 0.85rem;
  color: #555;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
}
</style>
</head>

<body>
<header>
  <h1><i data-lucide="stethoscope"></i> Cohortlab ‚Äì Asistente Cl√≠nico</h1>
  <button onclick="window.location.href='index.html'">Volver</button>
</header>

<main>
  <div class="chat-box">
    <h2>Chat</h2>
    <div id="messages" class="messages"></div>
    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu consulta..." />
      <button class="action" onclick="sendText()">Enviar</button>
    </div>
  </div>

  <div class="tabla-box">
    <h2>Resultados</h2>
    <div id="tablaContainer">Esperando resultados...</div>
    <div id="chartButtons"></div>
    <canvas id="chart"></canvas>
  </div>
</main>

<footer>¬© 2025 CohortIQ</footer>

<script>
lucide.createIcons();

const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const webhookGrafico = "https://rubaseval.app.n8n.cloud/webhook-test/grafico";

function appendMessage(sender, text) {
  const div = document.createElement("div");
  div.className = "msg " + sender;
  div.innerText = text;
  document.getElementById("messages").appendChild(div);
  const messages = document.getElementById("messages");
  messages.scrollTop = messages.scrollHeight;
}

document.getElementById("userInput").addEventListener("keydown", e => {
  if (e.key === "Enter") sendText();
});

async function sendText() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";

  const res = await fetch(webhook, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "text", content: text })
  });
  const data = await res.json();

  if (data.respuesta && data.respuesta.includes("|")) {
    renderMarkdownTable(data.respuesta);
    renderGraficarButton(data.sql, data.recomendacion, data.consulta);
  } else {
    appendMessage("bot", data.respuesta || "No hay respuesta del agente.");
  }
}

function renderMarkdownTable(md) {
  const lines = md.trim().split("\n").filter(l => l.includes("|"));
  if (lines.length < 2) return;
  const headers = lines[0].split("|").map(h => h.trim()).filter(Boolean);
  const rows = lines.slice(2).map(l => l.split("|").map(c => c.trim()).filter(Boolean));
  let html = "<table><thead><tr>";
  headers.forEach(h => html += `<th>${h}</th>`);
  html += "</tr></thead><tbody>";
  rows.forEach(r => html += "<tr>" + r.map(c => `<td>${c}</td>`).join("") + "</tr>");
  html += "</tbody></table>";
  document.getElementById("tablaContainer").innerHTML = html;
}

// ‚¨áÔ∏è BOT√ìN GRAFICAR
function renderGraficarButton(sql, recomendacion, consulta) {
  const cont = document.getElementById("chartButtons");
  cont.innerHTML = `<button class="btn-chart rec" id="btnGraficar">üìä Graficar</button>`;
  document.getElementById("btnGraficar").onclick = () => {
    renderChartSelection(sql, recomendacion, consulta);
  };
}

// ‚¨áÔ∏è AL HACER CLICK EN GRAFICAR ‚Üí mostrar todos los botones de tipo
function renderChartSelection(sql, recomendacion, consulta) {
  const tipos = ["bar", "line", "scatter", "pie", "histogram"];
  const rec = recomendacion.replace(/[()]/g, "").trim();
  const orden = [rec, ...tipos.filter(t => t !== rec)];

  const cont = document.getElementById("chartButtons");
  cont.innerHTML = `
    <p><strong>Selecciona tipo de gr√°fico:</strong></p>
    ${orden.map(t => `
      <button class="btn-chart ${t === rec ? "rec" : "alt"}"
        onclick="enviarGrafico('${sql}','${t}','${consulta}')">
        ${t === rec ? `Recomendado (${t})` : t}
      </button>
    `).join("")}
  `;
}

// ‚¨áÔ∏è AL SELECCIONAR UN GR√ÅFICO ‚Üí manda POST al webhook
async function enviarGrafico(sql, chartType, consulta) {
  try {
    await fetch(webhookGrafico, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sql, chart_type: chartType, consulta })
    });
    appendMessage("bot", `üìà Gr√°fico solicitado (${chartType}) enviado al servidor.`);
  } catch (err) {
    console.error(err);
    appendMessage("bot", "Error enviando gr√°fico al webhook.");
  }
}
</script>
</body>
</html>
